function redeemCouponCtrl($filter,$scope,$location,$translate,$state,$timeout,form,shoppoDialog){$scope.form=form,$scope.form.topBar.showTopBar=!0,$scope.form.topBar.showMenuBtn=!1,$scope.form.topBar.topBarTitle=$translate.instant("scanTheCode"),$scope.form.bottomMenu=!1,$scope.form.topBar.showBackBtn=!1,$scope.expandcode=!1,$scope.form.topBar.showShareBtn=!1,$scope.form.topBar.showCloseBtn=!0,$scope.page2=!0;var isFirst=!0;$scope.controlList=[],$scope.next=function(){$scope.page1=!1,$scope.page2=!0,$scope.clearCollectCodeStatus(),$timeout(function(){$(".flexsliderCode").flexslider({slideshow:!1,animation:"slide",animationLoop:!1,directionNav:!1,prevText:"",nextText:"",controlNav:!0})},60),$timeout(function(){generateQrCode($scope.collectCode),JsBarcode("#barcode",$scope.collectCode,{fontSize:40,textPosition:"top",textMargin:10,width:4,height:80,displayValue:!0}),$(".redeemCoupon").removeClass("hide"),$(".flexsliderCode").removeClass("hide");for(var i=0;i<$scope.selectCoupon.length;i++)$scope.selectCoupon[i].isSelect&&(eval("var qrCode = $scope.selectCoupon["+i+"].qrCode"),eval("$('.qrcode"+i+"').qrcode({'render': 'div','size': 160,'color': '#000000','text': qrCode,width: 160,height: 160,correctLevel: 3,background: '#fffffff',foreground: '#000000'})"));for(var i=0;i<$scope.selectCoupon.length;i++)$scope.selectCoupon[i].isSelect&&(eval("var barCode = $scope.selectCoupon["+i+"].qrCode"),eval("JsBarcode('#barcode"+i+"', barCode, {fontSize: 40,textPosition: 'top',textMargin: 10,width: 4,height: 80,displayValue: true})"))},70)},$scope.selectCoupon=[],$scope.selectCoupon.push({qrCode:$scope.form.myCouponDetail.qrCode,isSelect:!0,status:1}),$scope.selectCouponNum=1,$scope.leftLimit=!1,$scope.rightLimit=!1,$scope.currentNum=1,$scope.slidesCompare=0,$scope.getCampaignCoupon=function(){var a=copyData($scope.form.userInfo);$scope.form.fromCoupon?a.stampCardId=$scope.form.myCouponDetail.stampCardId:a.stampCardId=$scope.form.redeemCouponStampCardId;var b=apiDomain+listUserCoupon;$.ajax({type:AJAX_TYPE,data:a,url:b,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){if($scope.campaignCouponList=a.result,$scope.campaignCouponList.length>0){$scope.collectCode=$scope.campaignCouponList[0].collectCode;for(var b=0;b<$scope.campaignCouponList.length;b++)$scope.controlList.push({num:b});$timeout(function(){$(".flexslider").flexslider({slideshow:!1,animation:"slide",animationLoop:!1,directionNav:!1,prevText:"",nextText:"",controlNav:!1,after:function(a){if($scope.slidesCompare!=a.currentSlide){if(a.currentSlide<7&&"next"==a.direction&&$scope.currentNum++,a.currentSlide>6&&"next"==a.direction&&($(".controlBar").css("left",16*-(a.currentSlide-6)+"px"),$scope.currentNum++,$scope.currentNum>7&&($scope.currentNum=7),$scope.rightLimit=!0),"prev"==a.direction&&--$scope.currentNum<1){$scope.currentNum=1;var b=$(".controlBar").css("left").replace("px","");b=parseInt(b),0!=b&&(b+=16,$(".controlBar").css("left",b+"px"),$scope.rightLimit=!0)}$scope.slidesCompare=a.currentSlide}$(".controlBar li").removeClass("active"),$(".control"+a.currentSlide).addClass("active")}}),$(".flexslider").removeClass("hide");var a=$(".controlBar li").length;$(".controlBar").css("width",16*a+3+"px"),$(".control0").addClass("active")},60)}else $scope.collectCode=$scope.form.redeemCouponCollectCode,$scope.next();$(".redeemCoupon").removeClass("hide"),$scope.$apply()})}})},$scope.done=function(){$scope.form.fromCoupon?($scope.form.fromCoupon=!1,$location.path("main/promotion")):$location.path("main/stampsDetail")},$scope.clearCollectCodeStatus=function(){if(isFirst){isFirst=!1;var a=copyData($scope.form.userInfo);a.collectCode=$scope.collectCode;var b=apiDomain+clearCollectCodeStatus;sendGAEvent(a.collectCode,"Sticker-Collect","collect",1),$.ajax({type:AJAX_TYPE,data:a,url:b,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){$scope.$apply()})}})}},$scope.getCollectMsg=function(){var a=copyData($scope.form.userInfo);a.collectCode=$scope.collectCode;var b=apiDomain+getUserCollectStampMsg;$.ajax({type:AJAX_TYPE,data:a,url:b,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){$scope.posData=a.result,$scope.posMessage=a.result.msg,$scope.showRefresh=!1,$scope.haveScan=!1,0==$scope.posData.isScan?($scope.showRefresh=!0,$scope.haveScan=!1):1==$scope.posData.isScan&&($scope.showRefresh=!1,$scope.haveScan=!0,0==$scope.posData.scanStatus?($scope.posSuccess=!1,$scope.errorMsg=$scope.posMessage):1==$scope.posData.scanStatus&&($scope.posSuccess=!0)),$scope.showSuccess=!0,$scope.closeThisDialog=function(){$scope.showSuccess=!1,isFirst=!0,$timeout(function(){$scope.form.fromCoupon?($scope.form.fromCoupon=!1,$location.path("main/promotion")):$location.path("main/stampsDetail")},60)},shoppoDialog($scope,{templateUrl:"pages/common/JsBarcode128Dlg.html?rnd="+rndver,preCloseCallback:$scope.closeThisDialog}),$scope.$apply()})}})},$scope.$root.closePopup=function(){$scope.form.fromCoupon?($scope.form.fromCoupon=!1,$location.path("main/myCouponDetail")):$location.path("main/stampsDetail")},$scope.init=function(){$scope.collectCode=$scope.form.myCouponDetail.collectCode,$scope.next(),$timeout(function(){$(".redeemCode").height($(".main-content").height()-55)})},$scope.init()}var RedeemCouponCtrl=["$filter","$scope","$location","$translate","$state","$timeout","form","shoppoDialog",redeemCouponCtrl];angular.module("shoppoweb").controller("RedeemCouponCtrl",RedeemCouponCtrl);