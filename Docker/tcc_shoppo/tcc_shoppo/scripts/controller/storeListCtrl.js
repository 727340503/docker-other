function storeListCtrl(a,b,c,d,e,f,g,h){function j(a,b,c){b.addEventListener("click",function(b){k(a,b,c)})}function k(a,b,c){var d=b.target,e=new BMap.Point(d.getPosition().lng,d.getPosition().lat),f=new BMap.InfoWindow(a,c);o.openInfoWindow(f,e)}function l(a,b){b.addListener("click",function(){for(var c=0;c<u.length;c++)u[c].close();a.open(q,b)})}function m(){for(b.showStores=[],i=0;i<n.length;i++){1==BMapLib.GeoUtils.isPointInRect(n[i].point,o.getBounds())&&b.showStores.push(b.storeList[n[i].getTitle()])}g(function(){b.showStores=b.showStores})}b.form=f,b.form.topBar.showTopBar=!0,b.form.topBar.showMenuBtn=!1,f.topBar.showLogo=!1,b.form.topBar.topBarTitle=d.instant("Store"),b.form.topBar.showBackBtn=!0,b.form.bottomMenu=!1,b.form.topBar.lastPage="/main/more",b.$root.gotoLastPage=function(){c.path(b.form.topBar.lastPage)},b.showMap=!0,b.showList=!1,b.chooseMap=function(){b.showMap=!0,b.showList=!1},b.chooseList=function(){b.showMap=!1,b.showList=!0},b.getStoreList=function(){var a={};a.merchantId=b.form.userInfo.merchantId,a.langCode=b.form.userInfo.langCode;var c=apiDomain+listStore;$.ajax({type:AJAX_TYPE,data:a,url:c,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){b.storeList=a.result,b.merchantArea=[];for(var c=0;c<b.storeList.length;c++){b.storeList[c].phoneArray=b.storeList[c].phone.split("/"),b.storeList[c].showId=c;for(var d=!1,e=0;e<b.merchantArea.length;e++)b.storeList[c].merchantAreaId==b.merchantArea[e].merchantAreaId&&(d=!0);d||b.merchantArea.push({merchantAreaId:b.storeList[c].merchantAreaId,areaInfo:b.storeList[c].areaInfo})}b.mapEvent(),b.$apply(),$(document).ready(function(){$("#l-map").height($(".main-content").height()-150-46),$(".content").hide(),$(".title").find("span").addClass("icon-down"),$(".title").click(function(){$(this).find("span").toggleClass("icon-down icon-up").end().next(".content").slideToggle(300)})})})}})},b.checkPhone=function(a,b){return new RegExp("^[0-9|.|#|(|)|\\s|-]+$").test(a)?2!=b:1!=b},b.mapEvent=function(){g(function(){if(1==b.form.mapType){var a=document.createElement("script");a.src="https://api.map.baidu.com/api?v=2.0&ak="+baiduMapKey+"&s=1&callback=baiduInitialize",$("body").append(a)}else{var a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?v=3.26&key="+googleMapKey+"&libraries=places&callback=googleInitialize",document.body.appendChild(a)}})},b.init=function(){b.getStoreList(),$(".storeList-wrapper").height($(".main-content").height()-60)},b.init();var n=[];b.selectEvent=function(a){if(b.selectStoreId=a.storeId,1==b.form.mapType){for(var c={width:280,height:180,title:"",enableMessage:!0,offset:new BMap.Size(0,-18)},d=0;d<b.markerData.length;d++)if(b.markerData[d].storeId==a.storeId){var e=new BMap.Point(a.lng,a.lat),f=new BMap.InfoWindow(u[d],c);o.openInfoWindow(f,e)}}else for(var d=0;d<b.markerData.length;d++)b.markerData[d].storeId==a.storeId?(q.panTo(s[d].getPosition()),q.setZoom(18),u[d].open(q,s[d])):u[d].close()},b.gotoMyLocal=function(){1==b.form.mapType?o.centerAndZoom(p,15):q.panTo(r.getPosition())};var o,p;b.$root.baiduMapEvent=function(){if(o=new BMap.Map("l-map"),o.enableScrollWheelZoom(!0),translateCallback=function(a){if(0===a.status){var b=new BMap.Icon("./images/locator_yourlocation.png",new BMap.Size(30,30),{imageSize:new BMap.Size(30,30)});p=a.points[0],r&&o.removeOverlay(r),r=new BMap.Marker(a.points[0],{icon:b}),o.addOverlay(r),o.centerAndZoom(a.points[0],15)}},b.lng){var a=new BMap.Point(b.lng,b.lat),c=new BMap.Convertor,d=[];d.push(a),c.translate(d,1,5,translateCallback)}else{var e=new BMap.Point(b.storeList[0].lng,b.storeList[0].lat);o.centerAndZoom(e,15)}b.checkStore="All",b.titleText="All",t=!0,b.setMarkersEvent(b.storeList),o.addEventListener("tilesloaded",m),o.addEventListener("zoomend",m),o.addEventListener("moveend",m)};var q,r,s=[],t=!1;b.fitBounds=function(a){var b=new google.maps.LatLngBounds;for(i=0;i<a.length;i++)b.extend(a[i].getPosition());q.setCenter(b.getCenter()),q.fitBounds(b),q.setZoom(q.getZoom()),q.getZoom()>18&&q.setZoom(18),1==a.length&&q.setZoom(18)};var u=[];b.setMarkersEvent=function(a){if(b.markerData=a,b.showStores=[],0==b.form.mapType){s.forEach(function(a){a.setMap(null)}),s=[],u=[];for(var c=0;c<a.length;c++)if(a[c].lat){for(var d="",e=0;e<a[c].phoneArray.length;e++){var f=new RegExp("^[0-9|.|#|(|)|\\s|-]+$");f.test(a[c].phoneArray[e])?d+='<span><a href="tel:'+a[c].phoneArray[e]+'">'+a[c].phoneArray[e]+"</a>":d+="<span><span>"+a[c].phoneArray[e]+"</span>",e!=a[c].phoneArray.length-1&&(d+="<span> / </span>"),d+="</span>"}var g={lat:parseFloat(a[c].lat),lng:parseFloat(a[c].lng)},h="<div class='infoWindow storeList' style='width:280px;'>"+'<div class="subPage-content-style" style="padding: 0;margin-top: 0px;"><div class="form-group m-b-none" style="padding: 0 0px;"><label class="title-color wrap">'+a[c].name+'</label><div class="storeList-content"> <div class="f-l"><i class="icon-icon_store_list"></i></div><div class="f-r"><p class="cont font15 wrap">'+a[c].address+'</p></div></div><div class="storeList-content"><div class="f-l"><i class="icon-store_list_phone"></i></div><div class="f-r"><p class="cont font15 wrap">'+d+'</p></div></div><div class="storeList-content" ><div class="f-l"><i class="icon-store_list_time"></i></div><div class="f-r"><p class="cont font15 wrap">'+a[c].businessInfo+"</p></div></div></div></div></div>",i=new google.maps.InfoWindow({content:h});u.push(i);var k={url:"./images/locator_pin.png",size:new google.maps.Size(30,48)},m=new google.maps.Marker({position:g,map:q,icon:k,title:""+a[c].showId});l(i,m),s.push(m)}s.length>0&&b.fitBounds(s)}else{u=[],o.clearOverlays(),n=[];for(var p=[],c=0;c<a.length;c++){var r=new BMap.Point(a[c].lng,a[c].lat);p.push(r);var t=new BMap.Icon("./images/locator_pin.png",new BMap.Size(30,48),{imageSize:new BMap.Size(30,48)});n[c]=new BMap.Marker(r,{icon:t,title:""+a[c].showId}),o.addOverlay(n[c]);var h='<div class=\'infoWindow storeList\'><div class="subPage-content-style" style="padding: 0;margin-top: 0px;"><div class="form-group m-b-none" style="padding: 0 0px;"><label class="title-color wrap">'+a[c].name+'</label><div class="storeList-content"> <div class="f-l"><i class="icon-icon_store_list"></i></div><div class="f-r"><p class="cont font15 wrap">'+a[c].address+'</p></div></div><div class="storeList-content"><div class="f-l"><i class="icon-store_list_phone"></i></div><div class="f-r"><p class="cont font15 wrap"><span >'+a[c].phone+' </span></p></div></div><div class="storeList-content" ><div class="f-l"><i class="icon-store_list_time"></i></div><div class="f-r"><p class="cont font15 wrap">'+a[c].businessInfo+"</p></div></div></div></div></div>",v={width:280,height:180,title:"",enableMessage:!0,offset:new BMap.Size(0,-18)};u.push(h),j(h,n[c],v)}var w=o.getViewport(p);o.centerAndZoom(w.center,w.zoom)}},b.$root.googleMapEvent=function(){if(b.lat){var a={lat:parseFloat(b.lat),lng:parseFloat(b.lng)};q=new google.maps.Map(document.getElementById("l-map"),{zoom:15,center:a,disableDefaultUI:!0});var c={url:"./images/locator_yourlocation.png",size:new google.maps.Size(30,30)};r&&r.setMap(null),r=new google.maps.Marker({position:a,map:q,icon:c,title:""}),q.panTo(r.getPosition())}else{for(var d,e,f=0;f<b.storeList.length;f++)if(b.storeList[f].lat){d=b.storeList[f].lat,e=b.storeList[f].lng;break}if(d)var a={lat:parseFloat(d),lng:parseFloat(e)};else var a={lat:22.322409,lng:114.182154};q=new google.maps.Map(document.getElementById("l-map"),{zoom:10,center:a,disableDefaultUI:!0})}q.setClickableIcons(!1),b.setMarkersEvent(b.storeList),q.addListener("zoom_changed",function(){b.checkMarker()}),q.addListener("center_changed",function(){b.checkMarker()}),g(function(){b.checkStore="All",b.titleText="All",s.length>0&&b.fitBounds(s)},1e3),t=!0},b.showStores=[],b.checkMarker=function(){b.showStores=[];for(var a=s.length,c=q.getBounds();a--;)c.contains(s[a].getPosition())&&b.showStores.push(b.storeList[s[a].title]);g(function(){b.showStores=b.showStores})},b.haveAccept=!1,b.getLocation=function(a){inviteCallback=function(c){var d=JSON.parse(c);if(b.lat=d.latitude,b.lng=d.longitude,!b.lat&&0==d.type)return void b.popupLocTip();if(a&&1==d.type&&!b.lat)return void b.$root.warningDlg({msg:"Unable to locate your current location. Please enable location service and try again."});if(b.haveAccept=!0,t)if(1==b.form.mapType){translateCallback=function(a){if(0===a.status){var b=new BMap.Icon("./images/locator_yourlocation.png",new BMap.Size(30,30),{imageSize:new BMap.Size(30,30)});p=a.points[0],r&&o.removeOverlay(r),r=new BMap.Marker(a.points[0],{icon:b}),o.addOverlay(r),o.centerAndZoom(a.points[0],15)}};var e=new BMap.Point(b.lng,b.lat),f=new BMap.Convertor,g=[];g.push(e),f.translate(g,1,5,translateCallback)}else{var h={lat:parseFloat(b.lat),lng:parseFloat(b.lng)},i={url:"./images/locator_yourlocation.png",size:new google.maps.Size(30,30)};r&&r.setMap(null),r=new google.maps.Marker({position:h,map:q,icon:i,title:""}),q.panTo(r.getPosition())}},window.location="tcc://shoppo?func=getLocation&mapType="+b.form.mapType+"&callback=inviteCallback"},b.getLocation(!1),b.openLocServiceEvent=function(){window.location="tcc://shoppo?func=openLocationService"},b.popupLocTip=function(){b.showLocationTip=!0,b.closeThisDialog=function(a){b.showLocationTip=!1,1==a&&b.openLocServiceEvent()},h(b,{templateUrl:"pages/common/JsBarcode128Dlg.html?rnd="+rndver,preCloseCallback:b.closeThisDialog})},$(".mapTitle").width($(window).width()-30),b.showAreaList=function(){b.showSearch?b.showSearch=!1:b.showSearch=!0},b.checkStoreEvent=function(a,c){if("All"==a)b.setMarkersEvent(b.storeList);else if("Nearby"==a){if(!b.lat)return void b.getLocation(!0);for(var d=[],e=0;e<b.storeList.length;e++){var f=b.getDistance({lat:b.lat,lng:b.lng},{lat:parseFloat(b.storeList[e].lat),lng:parseFloat(b.storeList[e].lng)});f<1e3&&d.push(b.storeList[e])}d.length?b.setMarkersEvent(d):q.panTo(r.getPosition())}else{for(var d=[],e=0;e<b.storeList.length;e++)b.storeList[e].merchantAreaId==a&&d.push(b.storeList[e]);b.setMarkersEvent(d)}b.checkStore=a,b.titleText=a,c&&(b.titleText=c),b.showSearch=!1};var v=function(a){return a*Math.PI/180};b.getDistance=function(a,b){var c=v(b.lat-a.lat),d=v(b.lng-a.lng),e=Math.sin(c/2)*Math.sin(c/2)+Math.cos(v(a.lat))*Math.cos(v(b.lat))*Math.sin(d/2)*Math.sin(d/2);return 2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))*6378137}}function baiduInitialize(){angular.element("body").scope().$root.baiduMapEvent()}function googleInitialize(){angular.element("body").scope().$root.googleMapEvent()}var StoreListCtrl=["$filter","$scope","$location","$translate","$state","form","$timeout","shoppoDialog",storeListCtrl];angular.module("shoppoweb").controller("StoreListCtrl",StoreListCtrl);