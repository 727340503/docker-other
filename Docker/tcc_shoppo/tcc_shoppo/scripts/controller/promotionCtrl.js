function promotionCtrl(a,b,c,d,e,f,g,h){b.form=g,b.form.topBar.showTopBar=!0,b.form.topBar.showMenuBtn=!1,b.form.topBar.topBarTitle=d.instant("Promotion"),b.form.bottomMenu=!0,b.form.menuMerchantList=!0,b.form.topBar.lastPage="",b.pageNum=0,b.pageLimit=5,b.canGetMore=!0,b.myCouponList=[],b.openPromotion=function(){b.canGetMore=!0,b.pageNum=0,b.showPromotion=!0,b.showMyCoupon=!1,b.showExpiredCoupon=!1,b.getListPromotion(),b.form.fromMyCoupon=!1,b.form.fromCouponRecord=!1},b.openMyCoupon=function(){b.canGetMore=!0,b.pageNum=0,b.userCouponType=0,b.showPromotion=!1,b.showMyCoupon=!0,b.showExpiredCoupon=!1,b.form.fromMyCoupon||0==b.form.userInfo.userType||(b.myCouponList=[],b.getMyCoupon()),b.form.fromMyCoupon||0!=b.form.userInfo.userType||(b.myCouponList=[],b.listAllCoupon()),b.form.fromMyCoupon=!0,b.form.fromCouponRecord=!1},b.openExpiredCoupon=function(){b.canGetMore=!0,b.pageNum=0,b.userCouponType=2,b.showPromotion=!1,b.showMyCoupon=!1,b.showExpiredCoupon=!0,b.form.fromCouponRecord||0==b.form.userInfo.userType||(b.myCouponList=[],b.getMyCoupon()),b.form.fromCouponRecord||0!=b.form.userInfo.userType||(b.myCouponList=[]),b.form.fromMyCoupon=!1,b.form.fromCouponRecord=!0},b.sortCouponList=function(){for(var a,c,d=b.couponList.length;d>0;){for(a=0;a<d-1;a++)b.couponList[a].sortOrder>b.couponList[a+1].sortOrder&&(c=b.couponList[a],b.couponList[a]=b.couponList[a+1],b.couponList[a+1]=c);d--}},b.sortBannerList=function(){for(var a,c,d=b.bannerList.length;d>0;){for(a=0;a<d-1;a++)b.bannerList[a].sortOrder>b.bannerList[a+1].sortOrder&&(c=b.bannerList[a],b.bannerList[a]=b.bannerList[a+1],b.bannerList[a+1]=c);d--}},b.openLink=function(a,c,d,e){a&&(sendGAEvent(a,d+"-"+e,"click",1),1==c?1==b.form.isInApp?window.location="tcc://shoppo?func=inappUrl&url="+a:(b.form.webUrl=a,$("#iframed").empty(),$("#iframed").append("<i class='icon-close' onclick='back()'></i><iframe class='game-iframe' src='"+a+"'scrolling='no' frameborder='0' sandbox='allow-forms allow-scripts'></iframe>"),$("#iframed").css("display","block"),$("#home").css("display","none")):1==b.form.isInApp&&(window.location="tcc://shoppo?func=nativeUrl&url="+a))},b.getListPromotion=function(){var a=copyData(b.form.userInfo);a.username=a.userName;var c=apiDomain+listPromotion;$.ajax({type:AJAX_TYPE,data:a,url:c,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){b.bannerList=a.result.banners,b.haveBanner=!1;for(var c=0;c<b.bannerList.length;c++)2==b.bannerList[c].status&&(b.haveBanner=!0);b.sortBannerList(),b.$apply()})}})},b.getMyCoupon=function(){var a=copyData(b.form.userInfo),c=apiDomain+listUserCoupon;a.userCouponType=b.userCouponType,a.pageNum=b.pageNum,a.pageLimit=b.pageLimit,$.ajax({type:AJAX_TYPE,data:a,url:c,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){for(var c=0;c<a.result.length;c++)b.myCouponList.push(a.result[c]);a.result.length==b.pageLimit?b.canGetMore=!0:b.canGetMore=!1,b.$apply()})}})},b.saveAllCoupon=function(){var a=copyData(b.form.userInfo),c=apiDomain+saveUserAllCoupon;$.ajax({type:AJAX_TYPE,data:a,url:c,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){b.form.fromMyCoupon||b.form.fromCouponRecord?b.form.fromMyCoupon?(b.showPromotion=!1,b.showMyCoupon=!0,b.showExpiredCoupon=!1,b.userCouponType=0,b.getMyCoupon()):b.form.fromCouponRecord&&0!=b.form.userInfo.userType&&(b.showPromotion=!1,b.showMyCoupon=!1,b.showExpiredCoupon=!0,b.userCouponType=2,b.getMyCoupon()):(b.showPromotion=!0,b.showMyCoupon=!1,b.showExpiredCoupon=!1,b.getListPromotion()),b.$apply()})}})},b.listAllCoupon=function(){var a=copyData(b.form.userInfo),c=apiDomain+listCoupon;a.pageNum=b.pageNum,a.pageLimit=b.pageLimit,$.ajax({type:AJAX_TYPE,data:a,url:c,context:document.body,success:function(a){apiResultsProcessingFun(a,function(){for(var c=0;c<a.result.length;c++)b.myCouponList.push(a.result[c]);a.result.length==b.pageLimit?b.canGetMore=!0:b.canGetMore=!1,b.$apply()})}})},b.gotoCouponDetail=function(a){b.form.couponDetail=a,c.path("main/couponDetail")},b.gotoMyCouponDetail=function(a){b.form.myCouponDetail=a,c.path("main/myCouponDetail")},b.gotoRegistration=function(){c.path("main/registration")},b.instanceEvent=function(){$(".containner").bind("scroll",function(){var a=$(".containner").height(),c=$(".mainPage-content-style").height();$(".containner").scrollTop()>=c-a&&b.canGetMore&&(b.canGetMore=!1,b.pageNum++,b.showPromotion,b.showMyCoupon&&0!=b.form.userInfo.userType&&(b.userCouponType=0,b.getMyCoupon()),b.showMyCoupon&&0==b.form.userInfo.userType&&b.listAllCoupon(),b.showExpiredCoupon&&0!=b.form.userInfo.userType&&(b.userCouponType=2,b.getMyCoupon()),b.$apply())})},b.init=function(){0!=b.form.userInfo.userType?b.form.isCouponManagement?b.saveAllCoupon():(b.showPromotion=!0,b.getListPromotion()):b.form.fromMyCoupon||b.form.fromCouponRecord?b.form.fromMyCoupon&&(b.showPromotion=!1,b.showMyCoupon=!0,b.showExpiredCoupon=!1,b.userCouponType=0,b.listAllCoupon()):(b.showPromotion=!0,b.showMyCoupon=!1,b.showExpiredCoupon=!1,b.getListPromotion()),f(function(){b.form.isCouponManagement?$(".containner").css("height",$(window).height()-171+"px"):$(".containner").css("height",$(window).height()-125+"px"),b.instanceEvent()},100)},b.init()}var PromotionCtrl=["$filter","$scope","$location","$translate","$state","$timeout","form","shoppoDialog",promotionCtrl];angular.module("shoppoweb").controller("PromotionCtrl",PromotionCtrl);