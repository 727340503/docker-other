function couponListCtrl(a,b,c,d,e,f,g,h,i){a.langs=h.getAllLangs(),a.lang="zh-cn",a.canDrag=!1;var j={pageNumber:1,pageSize:50,sort:null},k=!1;a.checkPermission("COUPON_MANAGEMENT_DELETE")&&(k=!0),a.gridOptions={enableVerticalScrollbar:0,paginationPageSize:50,useExternalPagination:!0,useExternalSorting:!1,enableColumnResizing:!0,enablePaginationControls:!1,enableFullRowSelection:!1,multiSelect:!0,modifierKeysToMultiSelect:!1,enableRowSelection:!0,noUnselect:!1,rowHeight:48,enableRowHeaderSelection:k,rowTemplate:'<div grid="grid" ios-dblclick="grid.appScope.onDblClick(row)" class="ui-grid-draggable-row" draggable="true"><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader, \'custom\': true }" ui-grid-cell></div></div>',columnDefs:[{name:"Name",field:"name",minWidth:100,width:175,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Status",field:"status",minWidth:70,width:130,enableSorting:!1,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Merchant name",field:"merchantName",minWidth:100,width:175,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Campaign name",field:"campaignName",minWidth:100,width:175,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"}],onRegisterApi:function(b){a.gridApi=b,b.dragndrop.setDragDisabled(!1),a.gridApi.core.on.sortChanged(a,function(b,c){if(0==c.length)a.sortField="sortOrder",a.sortType="ASC";else{for(;c.length>1;)c[0].unsort(),c.shift();a.sortField=c[0].field,a.sortType=c[0].sort.direction.toUpperCase()}l()}),b.pagination.on.paginationChanged(a,function(a,b){j.pageNumber=a,j.pageSize=b,l()}),a.onDblClick=function(b){a.form.couponId=b.entity.id,a.checkPermission("COUPON_MANAGEMENT_UPDATE")&&(a.form.showSaveBtn=!0),e.path("/main/couponDetail")},b.draggableRows.on.rowDropped(a,function(b,c){if(a.canDrag){for(var d=this.grid.getVisibleRows(),e=0,f=0,g=[],h=0;h<d.length;h++){var i={};angular.copy(d[h].entity,i),g.push(i),d[h].entity==b.draggedRowEntity&&(e=h),d[h].entity==b.targetRowEntity&&(f=h)}var j=g[e];g.splice(f,0,j),f>e?g.splice(e,1):g.splice(e+1,1);for(var k=[],h=0;h<g.length;h++);for(var h=0;h<d.length;h++)if(g[h].sortOrder!=d[h].entity.sortOrder){g[h].sortOrder=d[h].entity.sortOrder;var i=g[h];k.push({id:i.id,displayLandingPage:i.displayLandingPage,sortOrder:i.sortOrder,updatedTime:i.updatedTime})}this.grid.appScope.updateCouponSortOrder(k)}}),b.selection.on.rowSelectionChanged(a,function(a){}),b.pagination.displayPage=function(){var a=[],c=0,d=b.pagination.getTotalPages(),e=5;b.pagination.getTotalPages()>e&&(b.pagination.getPage()>Math.ceil(e/2)?(c=b.pagination.getPage()-Math.ceil(e/2),d=b.pagination.getPage()+Math.floor(e/2),b.pagination.getPage()>b.pagination.getTotalPages()-Math.floor(e/2)&&(c=b.pagination.getTotalPages()-e),d>b.pagination.getTotalPages()&&(d=b.pagination.getTotalPages())):d=e);for(var f=c;f<d;f++)a.push(f+1);return a}}},a.getTableHeight=function(){var b=a.gridOptions.rowHeight;return{height:a.gridOptions.data.length*b+68+"px"}},a.updateCouponSortOrder=function(b){var c=apiDomain+updateCouponSortOrderApi,d=copyData(a.form.userInfo);d.sortOrderData=JSON.stringify(b),$.ajax({type:a.form.postType,url:c,context:document.body,data:d,success:function(a){apiResultsProcessingFun(a,function(){l()})}})};var l=function(){var b=(j.pageNumber-1)*j.pageSize,c=j.pageSize,d=b+c,e=apiDomain+getCouponListApi,f=copyData(a.form.userInfo);f.name=a.searchCouponName,f.langCode=a.searchLanguage,f.startRow=b,f.maxRows=c,f.sortType=a.sortType,f.sortField=a.sortField,f.merchantId=a.form.merchantId;for(var g="",h=0;h<a.searchStatus.length;h++)g+=a.searchStatus[h]+",";f.status=g,$.ajax({type:a.form.postType,url:e,context:document.body,data:f,success:function(c){apiResultsProcessingFun(c,function(){a.form.merchantId?a.canDrag=!0:a.canDrag=!1,a.gridOptions.totalItems=c.totalRows,a.gridOptions.data=c.resultList,a.gridOptions.startItem=b+1,d>a.gridOptions.totalItems&&(d=a.gridOptions.totalItems),0==a.gridOptions.totalItems&&(a.gridOptions.startItem=0),a.gridOptions.endItem=d,a.gridOptions.data.forEach(function(b,c){b.status=a.mappingStatus(b.status)}),a.$apply(),$(".ui-grid-row").css("cursor","pointer"),a.scrollTo(0,0)})}})};a.mappingStatus=function(a){var b="";switch(a){case 1:b=g("translate")("Pending");break;case 2:b=g("translate")("Active");break;case 3:b=g("translate")("Expired");break;case 4:b=g("translate")("Inactive");break;default:b=a}return b},a.search=function(){a.sortField="sortOrder",a.sortType="ASC",l()},a.scrollTo=function(b,c){a.gridApi.core.scrollTo(a.gridOptions.data[b],a.gridOptions.columnDefs[c])},a.form.showSaveBtn=!1,a.addCoupon=function(){a.form.couponId="",a.checkPermission("COUPON_MANAGEMENT_NEW")&&(a.form.showSaveBtn=!0),e.path("/main/couponDetail")},a.deleteUser=function(){function b(a,b,c,d,e){a.showOk=!0,a.msg=e("translate")("AreYouSure"),a.cancel=function(){b.dismiss("cancel")},a.ok=function(){a.deleteGift(),b.dismiss("cancel")}}if(0==a.gridApi.selection.getSelectedRows().length)return void a.alert("warning"," ","Please select the data first！");var c=["$scope","$modalInstance","$state","$translate","$filter",b];i.open({templateUrl:"pages/common/warningDlg.html",controller:c,scope:a})},a.deleteGift=function(){for(var b=a.gridApi.selection.getSelectedRows(),c=[],d=0;d<b.length;d++)c.push(b[d].id);var e=c.join(","),f=apiDomain+deleteCouponApi,g=copyData(a.form.userInfo);g.ids=e,$.ajax({type:a.form.postType,url:f,context:document.body,data:g,success:function(b){apiResultsProcessingFun(b,function(){a.alert("success"," ","Success！"),a.search()})}})},a.merchantListEvent=function(){var b=apiDomain+getMerchantListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.merchantList=b.resultList,a.merchantList.length&&(a.form.merchantId=a.merchantList[0].id+""),l(),a.$apply()})}})},a.init=function(){a.sortField="sortOrder",a.sortType="ASC",a.form=d,a.searchRewardName="",a.searchStatus=["1","2"],1==a.form.systemUserRole.roleType?(a.form.merchantId="",a.merchantListEvent()):l()},a.init()}var CouponListCtrl=["$scope","$translate","$http","form","$location","uiGridConstants","$filter","i18nService","$modal",couponListCtrl];angular.module("keeperp").controller("CouponListCtrl",CouponListCtrl);