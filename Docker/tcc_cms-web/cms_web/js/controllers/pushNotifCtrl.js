function pushNotifCtrl(a,b,c,d,e,f,g,h,i){a.langs=h.getAllLangs(),a.lang="zh-cn";var j={pageNumber:1,pageSize:30,sort:null};a.form.showSaveBtn=!1,a.gridOptions={paginationPageSize:30,enableVerticalScrollbar:0,enableGridMenu:!1,useExternalPagination:!0,useExternalSorting:!0,enableColumnResizing:!0,enableFullRowSelection:!1,enablePaginationControls:!1,multiSelect:!1,modifierKeysToMultiSelect:!1,noUnselect:!1,rowHeight:48,enableRowSelection:!0,rowTemplate:'<div ios-dblclick="grid.appScope.onDblClick(row)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',columnDefs:[{name:"Merchant Name",field:"merchantName",minWidth:70,width:130,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Message",field:"msg",minWidth:100,width:175,enableSorting:!1,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Status",field:"status",minWidth:100,width:175,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Publish date & time",field:"updatedTime",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"}],onRegisterApi:function(b){a.gridApi=b,a.gridApi.core.on.sortChanged(a,function(b,c){if(0==c.length)a.sortField="id",a.sortType="DESC";else{for(;c.length>1;)c[0].unsort(),c.shift();a.sortField=c[0].field,a.sortType=c[0].sort.direction.toUpperCase()}k()}),b.pagination.on.paginationChanged(a,function(a,b){j.pageNumber=a,j.pageSize=b,k()}),a.onDblClick=function(b){a.pushNotifId=b.entity.id,a.checkPermission("PUSH_NOTIFICATION_MANAGEMENT_UPDATE")?a.form.showSaveBtn=!0:a.form.showSaveBtn=!1,a.getPushNotifDetail()},b.pagination.displayPage=function(){var a=[],c=0,d=b.pagination.getTotalPages(),e=5;b.pagination.getTotalPages()>e&&(b.pagination.getPage()>Math.ceil(e/2)?(c=b.pagination.getPage()-Math.ceil(e/2),d=b.pagination.getPage()+Math.floor(e/2),b.pagination.getPage()>b.pagination.getTotalPages()-Math.floor(e/2)&&(c=b.pagination.getTotalPages()-e),d>b.pagination.getTotalPages()&&(d=b.pagination.getTotalPages())):d=e);for(var f=c;f<d;f++)a.push(f+1);return a}}},a.getTableHeight=function(){var b=a.gridOptions.rowHeight;return{height:a.gridOptions.data.length*b+68+"px"}};var k=function(){var b=(j.pageNumber-1)*j.pageSize,c=j.pageSize,d=b+c,e=apiDomain+getPushNotifListApi,f=copyData(a.form.userInfo);f.langCode=a.searchLanguage,f.startRow=b,f.maxRows=c,f.sortType=a.sortType,f.sortField=a.sortField,f.merchantId=a.form.merchantId,a.type=2,$.ajax({type:a.form.postType,url:e,context:document.body,data:f,success:function(c){apiResultsProcessingFun(c,function(){a.gridOptions.totalItems=c.totalRows,a.gridOptions.data=c.resultList,a.gridOptions.startItem=b+1,d>a.gridOptions.totalItems&&(d=a.gridOptions.totalItems),0==a.gridOptions.totalItems&&(a.gridOptions.startItem=0),a.gridOptions.endItem=d,a.gridOptions.data.forEach(function(b,c){b.updatedTime=2==b.status?b.updatedTime:"",b.status=a.mappingStatus(b.status)}),a.$apply(),a.scrollTo(0,0)})}})};a.mappingStatus=function(a){var b="";switch(a){case 1:b=g("translate")("UnSent");break;case 2:b=g("translate")("Sent");break;case 3:b=g("translate")("Failed");break;default:b=a}return b},a.search=function(){a.sortField="id",a.sortType="DESC",k()},a.scrollTo=function(b,c){a.gridApi.core.scrollTo(a.gridOptions.data[b],a.gridOptions.columnDefs[c])},a.getPushNotifDetail=function(){var b=apiDomain+getPushNotifDetailApi,c=copyData(a.form.userInfo);c.pushNotifId=a.pushNotifId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.pushNotifDetail=b.result,a.pushNotifDetail.pageRedirectType+="",a.form.merchantId=a.pushNotifDetail.merchantId+"",a.getMerchantDetail(),a.$apply()})}})},a.merchantListEvent=function(){var b=apiDomain+getMerchantListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.merchantList=b.resultList,a.$apply()})}})},a.selectMerchant=function(){k(),a.pushNotifId="",a.pushNotifDetail={},a.checkPermission("PUSH_NOTIFICATION_MANAGEMENT_NEW")&&(a.form.showSaveBtn=!0),a.form.merchantId&&a.getMerchantDetail()},a.cancelEvent=function(){a.pushNotifId="",a.pushNotifDetail.id="",a.pushNotifDetail.status="",a.checkPermission("PUSH_NOTIFICATION_MANAGEMENT_NEW")?a.form.showSaveBtn=!0:a.form.showSaveBtn=!1;for(var b=0;b<a.pushNotifDetail.pushNotifLangMaps.length;b++)a.pushNotifDetail.pushNotifLangMaps[b].msg=""},a.selectLanguage=function(){$timeout(function(){for(var b=0;b<a.pushNotifDetail.pushNotifLangMaps.length;b++)a.pushNotifDetail.pushNotifLangMaps[b].langCode==a.searchLanguage&&(a.pushNotifDetail.langData=a.pushNotifDetail.pushNotifLangMaps[b])})},a.getMerchantDetail=function(){var b=apiDomain+getMerchantDetailApi,c=copyData(a.form.userInfo);c.merchantId=a.form.merchantId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.merchantDetail=b.result,a.pushNotifId||(a.pushNotifDetail.pushNotifLangMaps=[]);for(var c=0;c<a.merchantDetail.merchantLangMapList.length;c++)a.merchantDetail.merchantLangMapList[c].isDefault&&(a.searchLanguage=a.merchantDetail.merchantLangMapList[c].langCode,a.pushNotifDetail.merchantName=a.merchantDetail.merchantLangMapList[c].name),a.pushNotifId||a.pushNotifDetail.pushNotifLangMaps.push({langCode:a.merchantDetail.merchantLangMapList[c].langCode,msg:""});a.$apply()})}})},$("#baseInfo").validate({errorPlacement:function(a,b){b.parent().after(a)},rules:{},messages:{},submitHandler:function(b){a.pushNotifDetail.id?a.updatePushNotif():a.createPushNotif()}}),a.saveEvent=function(){$("#baseInfo").submit()},a.createPushNotif=function(){var b=apiDomain+createPushNotifApi,c=copyData(a.form.userInfo);c.merchantId=a.form.merchantId,c.pageRedirectType=a.pushNotifDetail.pageRedirectType,c.langData=[];for(var d=0;d<a.pushNotifDetail.pushNotifLangMaps.length;d++)c.langData.push({langCode:a.pushNotifDetail.pushNotifLangMaps[d].langCode,msg:a.pushNotifDetail.pushNotifLangMaps[d].msg});c.langData=angular.toJson(c.langData),$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){k(),a.pushNotifId=b.result.id,a.pushNotifDetail.status=b.result.status,a.alert("success"," ","Success！"),a.$apply()})}})},a.updatePushNotif=function(){var b=apiDomain+updatePushNotifApi,c=copyData(a.form.userInfo);c.pushNotifId=a.pushNotifId,c.pageRedirectType=a.pushNotifDetail.pageRedirectType,c.langData=[];for(var d=0;d<a.pushNotifDetail.pushNotifLangMaps.length;d++)c.langData.push({id:a.pushNotifDetail.pushNotifLangMaps[d].id,langCode:a.pushNotifDetail.pushNotifLangMaps[d].langCode,msg:a.pushNotifDetail.pushNotifLangMaps[d].msg});c.langData=angular.toJson(c.langData),$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){k(),a.alert("success"," ","Success！"),a.$apply()})}})},a.publishPushNotif=function(){var b=apiDomain+publishPushNotifApi,c=copyData(a.form.userInfo);c.pushNotifId=a.pushNotifId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){k(),a.cancelEvent(),a.alert("success"," ","Success！"),a.$apply()})}})},a.init=function(){a.sortField="id",a.sortType="DESC",a.form=d,a.searchRewardName="",k(),a.pushNotifDetail={langData:{}},1==a.form.systemUserRole.roleType?(a.form.merchantId="",a.merchantListEvent()):(a.checkPermission("PUSH_NOTIFICATION_MANAGEMENT_NEW")&&(a.form.showSaveBtn=!0),a.getMerchantDetail())},a.init()}var PushNotifCtrl=["$scope","$translate","$http","form","$location","uiGridConstants","$filter","i18nService","$modal",pushNotifCtrl];angular.module("keeperp").controller("PushNotifCtrl",PushNotifCtrl);