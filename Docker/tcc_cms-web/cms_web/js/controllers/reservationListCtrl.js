function reservationListCtrl(a,b,c,d,e,f,g,h,i){a.langs=h.getAllLangs(),a.lang="zh-cn";var j={pageNumber:1,pageSize:30,sort:null},k=!1;a.checkPermission("ORDER_LIST_UPDATE")&&(k=!0),a.gridOptions={paginationPageSize:30,enableVerticalScrollbar:0,enableGridMenu:!1,useExternalPagination:!0,useExternalSorting:!0,enableColumnResizing:!0,enableFullRowSelection:!1,enablePaginationControls:!1,multiSelect:!0,modifierKeysToMultiSelect:!1,noUnselect:!1,rowHeight:48,enableRowSelection:!0,enableRowHeaderSelection:k,rowTemplate:'<div ios-dblclick="grid.appScope.onDblClick(row)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',columnDefs:[{name:"User name",field:"userName",minWidth:70,width:130,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Reserved reward",field:"giftName",minWidth:100,width:175,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Reservation status",field:"status",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Reservation code",field:"reservationCode",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Reservation date",field:"createdTime",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Pick up store name",field:"storeName",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"campaign",field:"campaignName",minWidth:20,width:140,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"},{name:"Merchant name",field:"merchantName",minWidth:70,width:130,enableSorting:!0,enableColumnResizing:!0,headerCellClass:"myTableHeader"}],onRegisterApi:function(b){a.gridApi=b,a.gridApi.core.on.sortChanged(a,function(b,c){if(0==c.length)a.sortField="id",a.sortType="DESC";else{for(;c.length>1;)c[0].unsort(),c.shift();a.sortField=c[0].field,a.sortType=c[0].sort.direction.toUpperCase()}l()}),b.pagination.on.paginationChanged(a,function(a,b){j.pageNumber=a,j.pageSize=b,l()}),a.onDblClick=function(b){a.form.userReservationId=b.entity.id,e.path("/main/reservationDetail")},b.pagination.displayPage=function(){var a=[],c=0,d=b.pagination.getTotalPages(),e=5;b.pagination.getTotalPages()>e&&(b.pagination.getPage()>Math.ceil(e/2)?(c=b.pagination.getPage()-Math.ceil(e/2),d=b.pagination.getPage()+Math.floor(e/2),b.pagination.getPage()>b.pagination.getTotalPages()-Math.floor(e/2)&&(c=b.pagination.getTotalPages()-e),d>b.pagination.getTotalPages()&&(d=b.pagination.getTotalPages())):d=e);for(var f=c;f<d;f++)a.push(f+1);return a}}},a.getTableHeight=function(){var b=a.gridOptions.rowHeight;return{height:a.gridOptions.data.length*b+68+"px"}};var l=function(){var b=(j.pageNumber-1)*j.pageSize,c=j.pageSize,d=b+c,e=apiDomain+getUserReservationListApi,f=copyData(a.form.userInfo);f.userName=a.searchUserName,f.langCode=a.searchLanguage,f.startRow=b,f.maxRows=c,f.sortType=a.sortType,f.sortField=a.sortField,f.merchantId=a.form.merchantId,f.status=a.searchStatus,f.reservationCode=a.reservationCode,f.giftId=a.giftId,f.campaignId=a.campaignId,f.reservationStartDate=a.startTime,f.reservationEndDate=a.endTime,f.storeName=a.storeName,$.ajax({type:a.form.postType,url:e,context:document.body,data:f,success:function(c){apiResultsProcessingFun(c,function(){a.gridOptions.totalItems=c.totalRows,a.gridOptions.data=c.resultList,a.gridOptions.startItem=b+1,d>a.gridOptions.totalItems&&(d=a.gridOptions.totalItems),0==a.gridOptions.totalItems&&(a.gridOptions.startItem=0),a.gridOptions.endItem=d,a.gridOptions.data.forEach(function(b,c){b.status=a.mappingStatus(b.status)}),a.$apply(),$(".ui-grid-row").css("cursor","pointer"),a.scrollTo(0,0)})}})};a.mappingStatus=function(a){var b="";switch(a){case 1:b=g("translate")("Confirmed");break;case 2:b=g("translate")("Available at store");break;case 3:b=g("translate")("Settled");break;case 4:b=g("translate")("Expired");break;case 5:b=g("translate")("Incompleted");break;case 6:b=g("translate")("Cancelled");break;default:b=a}return b},a.search=function(){a.sortField="id",a.sortType="DESC",l()},a.scrollTo=function(b,c){a.gridApi.core.scrollTo(a.gridOptions.data[b],a.gridOptions.columnDefs[c])},a.AvailableAtStoreDB=function(b){function c(a,c,d,e,f){a.showOk=!0,a.msg="When status set as available at store, system send in-app notification to user automatically",a.cancel=function(){c.dismiss("cancel")},a.ok=function(){a.changeStatus(b),a.form.closeDlg(),c.dismiss("cancel")}}var d=["$scope","$modalInstance","$state","$translate","$filter",c];i.open({templateUrl:"pages/common/warningDlg.html",controller:d,scope:a})},a.changeStatus=function(b){for(var c=a.gridApi.selection.getSelectedRows(),d=[],e=0;e<c.length;e++)d.push(c[e].id);var f=d.join(","),g=apiDomain+updateUserReservationStatusApi,h=copyData(a.form.userInfo);h.status=2,h.ids=f,h.merchantId=a.form.merchantId,h.reservationExpiredTime=b,$.ajax({type:a.form.postType,url:g,context:document.body,data:h,success:function(b){apiResultsProcessingFun(b,function(){a.alert("success"," ","Success！"),a.search()})}})},a.merchantListEvent=function(){var b=apiDomain+getMerchantListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.merchantList=b.resultList,a.form.merchantId=a.merchantList[0].id+"",a.getCampaignList(),a.$apply()})}})},a.getCampaignList=function(){a.campaignId="";var b=apiDomain+getCampaignListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",c.merchantId=a.form.merchantId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.campaignList=b.resultList,a.$apply()})}})},a.getCampaignGiftList=function(){if(!a.campaignId)return a.giftId="",void(a.campaignGiftList=[]);var b=apiDomain+getCampaignGiftListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",c.campaignId=a.campaignId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.campaignGiftList=b.resultList,a.$apply()})}})},a.init=function(){a.form=d,a.searchRewardName="",1==a.form.systemUserRole.roleType?(a.form.merchantId="",a.merchantListEvent()):a.getCampaignList()};var m=$("#datetimepicker1"),n=$("#datetimepicker2");m.on("dp.change",function(a){n.data("DateTimePicker").minDate(a.date)}),n.on("dp.change",function(a){m.data("DateTimePicker").maxDate(a.date)}),a.init(),a.AvailableAtStore=function(b,c,d){function e(a,b,c,d,e){a.showOk=!0,a.opened=!1,a.msg=e("translate")("AreYouSure"),a.cancel=function(){b.dismiss("cancel")},a.ok=function(){$("#time").submit()},a.form.closeDlg=function(){b.dismiss("cancel")},a.readyEvent=function(){if(!a.opened){$(".inmodal").parent().parent().width(1e3),a.opened=!0;var b=a.gridApi.selection.getSelectedRows();a.selectedData=[];for(var c=0;c<b.length;c++)a.selectedData.push(b[c]);$("#time").validate({errorPlacement:function(a,b){b.parent().after(a)},rules:{},messages:{},submitHandler:function(b){a.AvailableAtStoreDB(a.reservationExpiredTime)}})}}}if(0==a.gridApi.selection.getSelectedRows().length)return void a.alert("warning"," ","Please select the data first！");var f=["$scope","$modalInstance","$state","$translate","$filter",e];i.open({templateUrl:"pages/common/reservationDlg.html",controller:f,scope:a})}}var ReservationListCtrl=["$scope","$translate","$http","form","$location","uiGridConstants","$filter","i18nService","$modal",reservationListCtrl];angular.module("keeperp").controller("ReservationListCtrl",ReservationListCtrl);