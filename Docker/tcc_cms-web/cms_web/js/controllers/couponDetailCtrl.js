function couponDetailCtrl(a,b,c,d,e,f,g){if(a.form=e,a.cancel=function(){f.path("/main/couponList")},a.form.couponId)var h={collectStartTime:{checkCollectTime:!0,checkCollectStart:!0},collectEndTime:{checkCollectTime:!0,checkCollectEnd:!0},redeemStartTime:{checkRedeemTime:!0,checkRedeemStart:!0},redeemEndTime:{checkRedeemTime:!0,checkRedeemEnd:!0}};else var h={logo:{required:!0},collectStartTime:{checkCollectTime:!0,checkCollectStart:!0},collectEndTime:{checkCollectTime:!0,checkCollectEnd:!0},redeemStartTime:{checkRedeemTime:!0,checkRedeemStart:!0},redeemEndTime:{checkRedeemTime:!0,checkRedeemEnd:!0}};jQuery.validator.addMethod("checkCollectTime",function(b,c,d){return a.couponDetail.collectStartTime<=a.couponDetail.collectEndTime},$.validator.format("Start time must ealier then end time.")),jQuery.validator.addMethod("checkRedeemTime",function(b,c,d){return a.couponDetail.redeemStartTime<=a.couponDetail.redeemEndTime},$.validator.format("Start time must ealier then end time.")),jQuery.validator.addMethod("checkCollectStart",function(b,c,d){return a.campaignDetail.collStartTime<=a.couponDetail.collectStartTime},$.validator.format("Must be within campaign collect stamp period.")),jQuery.validator.addMethod("checkCollectEnd",function(b,c,d){return a.campaignDetail.collEndTime>=a.couponDetail.collectEndTime},$.validator.format("Must be within campaign collect stamp period.")),jQuery.validator.addMethod("checkRedeemStart",function(b,c,d){return a.campaignDetail.collStartTime<=a.couponDetail.redeemStartTime},$.validator.format("Must be within campaign collect stamp period.")),jQuery.validator.addMethod("checkRedeemEnd",function(b,c,d){return a.campaignDetail.collEndTime>=a.couponDetail.redeemEndTime},$.validator.format("Must be within campaign collect stamp period.")),$("#baseInfo").validate({errorPlacement:function(a,b){b.parent().after(a)},rules:h,messages:{},submitHandler:function(b){a.form.couponId?a.updateCoupon():a.addCoupon()}}),a.addCoupon=function(){var b=apiDomain+createCouponApi,c=copyData(a.form.userInfo);c.campaignId=a.couponDetail.campaignId,c.collectStartTime=a.couponDetail.collectStartTime,c.collectEndTime=a.couponDetail.collectEndTime,c.redeemStartTime=a.couponDetail.collectStartTime,c.redeemEndTime=a.couponDetail.collectEndTime,"1"==a.couponDetail.quotaType?c.totalQty=a.couponDetail.totalQty:c.totalQty=-1,c.type=a.couponDetail.type,c.rewardQty=a.couponDetail.rewardQty,c.maxRewardQty=a.couponDetail.maxRewardQty,c.isUseWithOtherCoupon=a.couponDetail.isUseWithOtherCoupon,c.isUseWithSameCoupon=a.couponDetail.isUseWithSameCoupon,c.isTransferrable=a.couponDetail.isTransferrable,c.isAfterCollect=!1,c.collectMethodData=[{collectMethod:a.couponDetail.collectMethod}],a.couponDetail.collectType&&(c.collectQuotaData=[{collectQuotaType:5,collectQuotaQty:a.couponDetail.collectQuotaQty}]),c.redeemMethodData=[{redeemMethod:0}],c.redeemQuotaData=[],a.couponDetail.redeemType&&c.redeemQuotaData.push({redeemQuotaType:5,redeemQuotaQty:a.couponDetail.redeemQuotaQty}),a.couponDetail.redeemQuotaQty2&&c.redeemQuotaData.push({redeemQuotaType:6,redeemQuotaQty:a.couponDetail.redeemQuotaQty2}),c.collectMethodData=angular.toJson(c.collectMethodData),c.collectQuotaData=angular.toJson(c.collectQuotaData),c.redeemMethodData=angular.toJson(c.redeemMethodData),c.redeemQuotaData=angular.toJson(c.redeemQuotaData),c.issuedQuotaType=0,a.couponDetail.langData.img=a.image,c.langData=[{name:a.couponDetail.langData.name,img:a.couponDetail.langData.img,terms:a.couponDetail.langData.terms,descr:a.couponDetail.langData.descr,langCode:a.couponDetail.langData.langCode}],c.langData=angular.toJson(c.langData),$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.alert("success"," ","Success！"),d(function(){f.path("/main/couponList")})})}})},a.getCouponDetail=function(){var b=apiDomain+getCouponDetailApi,c=copyData(a.form.userInfo);c.couponId=a.form.couponId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.couponDetail=b.result,a.couponDetail.merchantId+="",a.couponDetail.campaignId+="",a.couponDetail.status+="",a.couponDetail.type+="",a.couponDetail.isTransferrable+="",a.couponDetail.isUseWithOtherCoupon+="",a.couponDetail.isUseWithSameCoupon+="",-1==a.couponDetail.totalQty&&(a.couponDetail.totalQty=""),a.couponDetail.totalQty&&(a.couponDetail.quotaType="1"),a.couponDetail.collectMethod=a.couponDetail.collectMethodData[0].collectMethod+"";for(var c=0;c<a.couponDetail.collectQuotaData.length;c++)5==a.couponDetail.collectQuotaData[c].collectQuotaType&&(a.couponDetail.collectType="1",a.couponDetail.collectQuotaQty=a.couponDetail.collectQuotaData[c].collectQuotaQty);for(var c=0;c<a.couponDetail.redeemQuotaData.length;c++)5==a.couponDetail.redeemQuotaData[c].redeemQuotaType&&(a.couponDetail.redeemType="1",a.couponDetail.redeemQuotaQty=a.couponDetail.redeemQuotaData[c].redeemQuotaQty),6==a.couponDetail.redeemQuotaData[c].redeemQuotaType&&(a.couponDetail.redeemQuotaQty2=a.couponDetail.redeemQuotaData[c].redeemQuotaQty);a.couponDetail.langData=a.couponDetail.couponLangMaps[0],a.image=a.couponDetail.langData.img,a.couponDetail.langData.img=a.couponDetail.langData.fullImg,a.pageLanguage=a.couponDetail.langData.langCode,1==a.form.systemUserRole.roleType?a.merchantListEvent():(a.couponDetail.merchantId=a.form.merchantId,a.getMerchantDetail(a.form.merchantId)),a.getCampaignDetail(),a.$apply()})}})},a.updateCoupon=function(){var b=apiDomain+updateCouponApi,c=copyData(a.form.userInfo);c.couponId=a.form.couponId,c.isAfterCollect=!1,c.campaignId=a.couponDetail.campaignId,c.collectStartTime=a.couponDetail.collectStartTime,c.collectEndTime=a.couponDetail.collectEndTime,c.redeemStartTime=a.couponDetail.collectStartTime,c.redeemEndTime=a.couponDetail.collectEndTime,"1"==a.couponDetail.quotaType?c.totalQty=a.couponDetail.totalQty:c.totalQty=-1,c.status=a.couponDetail.status,c.type=a.couponDetail.type,c.rewardQty=a.couponDetail.rewardQty,c.maxRewardQty=a.couponDetail.maxRewardQty,c.isUseWithSameCoupon=a.couponDetail.isUseWithSameCoupon,c.isUseWithOtherCoupon=a.couponDetail.isUseWithOtherCoupon,c.isTransferrable=a.couponDetail.isTransferrable,c.collectMethodData=[{collectMethod:a.couponDetail.collectMethod}],c.collectQuotaData=[{collectQuotaType:5,collectQuotaQty:1}],c.redeemMethodData=[{redeemMethod:0}],c.redeemQuotaData=[],c.redeemQuotaData.push({redeemQuotaType:5,redeemQuotaQty:1}),c.redeemQuotaData.push({redeemQuotaType:6,redeemQuotaQty:1}),c.collectMethodData=angular.toJson(c.collectMethodData),c.collectQuotaData=angular.toJson(c.collectQuotaData),c.redeemMethodData=angular.toJson(c.redeemMethodData),c.redeemQuotaData=angular.toJson(c.redeemQuotaData),c.issuedQuotaType=0,c.langData=[{id:a.couponDetail.langData.id,name:a.couponDetail.langData.name,img:a.image,langCode:a.couponDetail.langData.langCode,descr:a.couponDetail.langData.descr}],c.langData=angular.toJson(c.langData),$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.alert("success"," ","Success！"),a.getCouponDetail()})}})},a.getCampaignList=function(){var b=apiDomain+getCampaignListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",c.merchantId=a.couponDetail.merchantId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.campaignList=b.resultList,a.$apply()})}})},a.getCampaignDetail=function(){if(a.couponDetail.campaignId){var b=apiDomain+getCampaignDetailApi,c=copyData(a.form.userInfo);c.campaignId=a.couponDetail.campaignId,$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.campaignDetail=b.result,a.form.couponId||(a.couponDetail.collectStartTime=a.campaignDetail.collStartTime,a.couponDetail.collectEndTime=a.campaignDetail.collEndTime,a.couponDetail.redeemStartTime=a.campaignDetail.collStartTime,a.couponDetail.redeemEndTime=a.campaignDetail.collEndTime),a.$apply()})}})}},a.daysData=function(a){var b=new Date(a),c=b.getFullYear(),d=b.getMonth()+1,e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c+"-"+(d<10?"0"+d:d+"")+"-"+(e<10?"0"+e:e+"")+" "+f+":"+g+":"+h},a.merchantListEvent=function(){var b=apiDomain+getMerchantListApi,c=copyData(a.form.userInfo);c.startRow=0,c.maxRows=1e6,c.sortType="ASC",c.sortField="id",$.ajax({type:a.form.postType,url:b,context:document.body,data:c,success:function(b){apiResultsProcessingFun(b,function(){a.merchantList=b.resultList,a.$apply()})}})},a.getMerchantDetail=function(b){a.getCampaignList();var c=apiDomain+getMerchantDetailApi,d=copyData(a.form.userInfo);d.merchantId=b,$.ajax({type:a.form.postType,url:c,context:document.body,data:d,success:function(b){apiResultsProcessingFun(b,function(){for(var c=0;c<a.form.languageList.length;c++)a.form.languageList[c].select=!1;a.merchantDetail=b.result;for(var c=0;c<a.merchantDetail.merchantLangMapList.length;c++)a.merchantDetail.merchantLangMapList[c].isDefault&&(a.couponDetail.langData.langCode=a.merchantDetail.merchantLangMapList[c].langCode);a.$apply()})}})},a.selectPageLang=function(){d(function(){for(var b=0;b<a.couponDetail.couponLangMaps.length;b++)a.couponDetail.couponLangMaps[b].langCode==a.pageLanguage&&(a.couponDetail.langData=a.couponDetail.couponLangMaps[b],a.image=a.couponDetail.langData.img,a.couponDetail.langData.img=a.couponDetail.langData.fullImg)})},a.duplicateEvent=function(){d(function(){a.getCampaignList(),a.form.couponId="",a.couponDetail.id="",a.couponDetail.campaignId="",a.couponDetail.collectStartTime="",a.couponDetail.collectEndTime="",a.couponDetail.redeemStartTime="",a.couponDetail.redeemEndTime="",$("body").scrollTop(0),a.alert("success"," ","Success！You can click Save button to create new coupon.")})},a.uploadFinish=function(b,c){a.couponDetail.langData.img=c.fullName,a.image=c.fileName,a.$apply()},a.form.couponId?a.getCouponDetail():(a.couponDetail={langData:{},type:"1",isTransferrable:"false",isUseWithOtherCoupon:"true",isUseWithSameCoupon:"true",collectType:"1",redeemType:"1",collectQuotaQty:1,redeemQuotaQty:1,redeemQuotaQty2:1,collectMethod:"2"},1==a.form.systemUserRole.roleType?(a.merchantListEvent(),a.getCampaignList()):(a.couponDetail.merchantId=a.form.merchantId,a.getMerchantDetail(a.form.merchantId),a.getCampaignList()))}var CouponDetailCtrl=["$scope","$translate","$state","$timeout","form","$location","$modal",couponDetailCtrl];angular.module("keeperp").controller("CouponDetailCtrl",CouponDetailCtrl);